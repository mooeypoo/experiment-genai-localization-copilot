# Agent Notes 03

## 1) Summary
- Added a global "Viewing as" user selector in the header that persists across navigation.
- Moved comment authorship from form-level selection to the global viewing user.
- Implemented validation logic in the data abstraction layer as requested.
- Updated UI to display validation errors clearly to users.
- Ensured the viewing user state is shared across components via a composable pattern.

## 2) Decisions & Rationale
- **Composable for viewing user state:** Created `useViewingUser` composable to manage global viewing user state without introducing a full state management library. This keeps the pattern lightweight and Vue-native.
- **Validation in data layer:** Moved validation logic to `store.js` per the requirement to keep logic in the data abstraction layer. The `validateComment` function is exported and used by the UI, while `createComment` also validates internally and throws errors.
- **Error handling strategy:** Used both preemptive validation (in the form) and defensive validation (in the store) to provide immediate feedback while ensuring data integrity.
- **Header integration:** Placed the ViewingAsSelector in the header rather than within individual forms to make the "viewing as" concept global and consistent across the entire app experience.
- **Avatar display in selector:** Added a small avatar preview next to the selector to provide visual confirmation of the selected user.

## 3) Ambiguities Encountered
- **Where to store viewing user state**
  - Options considered: (a) Vue provide/inject, (b) composable with module-level ref, (c) Pinia or similar state library.
  - Resolution: chose composable with module-level ref for simplicity and to avoid adding dependencies. This creates a singleton-like pattern that works for this demo scale.
  
- **Validation placement**
  - Options considered: (a) validation only in UI, (b) validation only in store, (c) validation in both places.
  - Resolution: implemented in both placesâ€”UI validation provides immediate feedback, store validation ensures data integrity even if called programmatically.
  
- **Error display approach**
  - Options considered: (a) inline error messages, (b) toast notifications, (c) validation badges.
  - Resolution: used inline error messages below the form for clarity and accessibility.

- **Default viewing user**
  - Options considered: (a) no default (force selection), (b) first user in list, (c) remember last selection.
  - Resolution: default to first user for simplicity; more sophisticated persistence can be added later if needed.

## 4) Tradeoffs
- **Global state in composable vs state library:** Simpler setup and fewer dependencies, but less structured than a formal state management solution. Acceptable for this app's scale.
- **Dual validation:** More code to maintain, but provides better UX (immediate feedback) and stronger data integrity guarantees.
- **Loading users in App.vue:** Centralizes user data loading but creates a dependency at the root level. Alternative would be lazy loading per route, but global viewing user requires early data availability.
- **Error thrown vs returned:** `createComment` throws errors rather than returning them, which is more idiomatic for invariant violations but requires try/catch handling.

## 5) Non-Goals
- Persisting viewing user selection across page refreshes (would require localStorage or similar).
- Advanced validation rules like profanity filtering or link detection.
- Real-time validation as the user types (only validates on submit).
- Undo/redo for comment creation.
- Multi-user concurrent editing scenarios.

## 6) Files Changed
- Added: [src/composables/useViewingUser.js](../../src/composables/useViewingUser.js)
- Added: [src/components/ViewingAsSelector.vue](../../src/components/ViewingAsSelector.vue)
- Updated: [src/components/HeaderBar.vue](../../src/components/HeaderBar.vue)
- Updated: [src/components/CommentForm.vue](../../src/components/CommentForm.vue)
- Updated: [src/views/PostView.vue](../../src/views/PostView.vue)
- Updated: [src/App.vue](../../src/App.vue)
- Updated: [src/data/store.js](../../src/data/store.js)
- Updated: [src/style.css](../../src/style.css)
- Added: [docs/agent-notes/03.md](03.md)

## 7) Manual Verification Checklist
- Run `npm run dev` and confirm the "Viewing as" selector appears in the header.
- Select different users from the viewing selector and verify the avatar updates.
- Navigate between routes and confirm the viewing user persists.
- Try to submit an empty comment and verify the error message appears.
- Try to submit a comment longer than 500 characters and verify rejection.
- Submit a valid comment and confirm it appears with the correct author.
- Check the console to ensure no errors are thrown.
- Test on mobile viewport to confirm responsive layout works.

## 8) Known Issues / Follow-ups
- Viewing user selection is not persisted across page refreshes; resets to first user.
- No character counter to help users stay within the 500-character limit.
- The validation error styling could be enhanced with icons or animations.
- No loading state while comment is being added (currently synchronous but could feel abrupt with network delays if backend were added).
- The UserForm component still exists but doesn't use the viewing user pattern; could be updated for consistency in a future step.
